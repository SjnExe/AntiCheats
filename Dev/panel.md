# AddonExe Panel System Documentation

This document outlines the structure, components, and logic of the AddonExe UI panel system. It is intended to serve as a reference for the planned refactoring.

## 1. Panel and Button Definitions

This section lists all available panels and details their buttons, icons, and actions. The primary source for this is `AddonExeBP/scripts/core/panelLayoutConfig.js`.

---

### **`mainPanel`**
- **Title:** `§l§3Panel§r` (Dynamically replaced with `serverName` from config)
- **Parent:** `null`

| Button ID | Text | Icon | Action | Target |
| :--- | :--- | :--- | :--- | :--- |
| `playerManagement` | `§cPlayer Management` | `textures/ui/icon_multiplayer` | `openPanel` | `playerListPanel` |
| `publicPlayerList` | `§2View Players` | `textures/ui/icon_multiplayer` | `openPanel` | `publicPlayerListPanel` |
| `reportManagement` | `§cReport Management` | `textures/ui/WarningGlyph` | `openPanel` | `reportListPanel` |
| `moderation` | `§cModeration` | `textures/ui/hammer_l.png` | `openPanel` | `moderationPanel` |
| `testPanel` | `§eTest Panel` | `textures/ui/icon_setting` | `openPanel` | `testPanel` |
| `bountyList` | `§cBounty List` | `textures/items/netherite_sword.png` | `openPanel` | `bountyListPanel` |
| `rules` | `§eRules` | `textures/items/book_enchanted.png` | `functionCall` | `showRules` |
| `myStats` | `§3My Stats` | `textures/ui/profile_glyph_color.png` | `openPanel` | `myStatsPanel` |
| `helpfulLinks` | `§9Helpful Links` | `textures/items/chain` | `openPanel` | `helpfulLinksPanel` |

---

### **`playerManagementPanel`**
- **Title:** `§l§cActions for {playerName}§r`
- **Parent:** `playerListPanel`

| Button ID | Text | Icon | Action | Target |
| :--- | :--- | :--- | :--- | :--- |
| `teleportToPlayer` | `§8Teleport to Player` | `textures/ui/flyingascend.png` | `functionCall` | `teleportTo` |
| `teleportPlayerHere` | `§8Teleport Player Here`| `textures/ui/flyingdescend.png` | `functionCall` | `teleportHere` |
| `freezePlayer` | `§eFreeze Player` | `textures/ui/lock_color.png` | `functionCall` | `toggleFreeze` |
| `mutePlayer` | `§eMute Player` | `textures/ui/mute_on.png` | `functionCall` | `showMuteForm` |
| `unmutePlayer` | `§2Unmute Player` | `textures/ui/mute_off.png` | `functionCall` | `showUnmuteForm` |
| `kickPlayer` | `§cKick Player` | `textures/ui/icon_import.png` | `functionCall` | `showKickForm` |
| `clearInventory` | `§cClear Inventory` | `textures/ui/trash` | `functionCall` | `clearInventory` |
| `banPlayer` | `§cBan Player` | `textures/ui/hammer_l.png` | `functionCall` | `showBanForm` |

---

### **`moderationPanel`**
- **Title:** `§l§cModeration Tools§r`
- **Parent:** `mainPanel`

| Button ID | Text | Icon | Action | Target |
| :--- | :--- | :--- | :--- | :--- |
| `unbanPlayer` | `§2Unban Player` | `textures/ui/check.png` | `functionCall` | `showUnbanForm` |

---
*Note: Other panels like `publicPlayerActionsPanel`, `reportActionsPanel`, etc., follow the same structure. Panels with `items: []` are populated dynamically at runtime by a builder function in `uiManager.js` (e.g., `buildPlayerListForm`).*


## 2. Core Features & Implementation Notes

This section covers the implementation details of key UI-related features.

### **2.1. Working Standalone Features**
These features are simple and self-contained, making them good candidates for preservation in a refactor.

- **`myStatsPanel`**: This is a "body-only" panel. The content is not made of buttons but is generated by the `addPanelBody` function in `uiManager.js`, which reads the player's own data (`balance`, `rank`, etc.) and displays it.
- **`helpfulLinksPanel`**: Similar to `myStatsPanel`, this panel's body is dynamically generated by `addPanelBody` using link values from `config.js`.
- **`showRules` action**: This is a `functionCall` that triggers the `showRules` function in `uiManager.js`. This function creates a new `ActionFormData` on the fly, populates its body with the rules from `config.js`, and shows it to the player.

### **2.2. Universal Back Button**
The back button has two different implementations, creating an inconsistency:

1.  **Static Panels**: For most panels defined with items in `panelLayoutConfig.js`, the `getMenuItems` function in `uiManager.js` automatically prepends a "Back" button if the panel definition has a `parentPanelId`. This is the "universal" implementation.
2.  **Dynamic List Panels**: For panels whose content is generated by a builder function (e.g., `buildPlayerListForm` for the player list), the "Back" button is hardcoded directly inside that builder function. This is a separate, manual implementation.

## 3. Core Logic and Flow

The entire panel system is orchestrated by `uiManager.js`. Understanding its core loop is key to working with panels.

1.  **Initiation**: The process starts when `showPanel(player, panelId, context)` is called. The initial call comes from the `!panel` command, which executes `showPanel(player, 'mainPanel')`.
2.  **Form Building**: `showPanel` calls `buildPanelForm`. This function looks up the `panelId` in `panelLayoutConfig.js` and constructs an `ActionFormData` object. It adds the title, body (if any), and all the buttons the player has permission to see.
3.  **Display and Wait**: The constructed form is shown to the player using `utils.uiWait`, which handles the `UserBusy` issue (see below). The system then waits for the player to make a selection.
4.  **Response Handling**: Once the player clicks a button, `handleFormResponse` is called with the player's selection.
5.  **Action Execution**: `handleFormResponse` determines the action associated with the button:
    - If it's an `openPanel` action, it simply calls `showPanel` again with the new `panelId`, restarting the loop.
    - If it's a `functionCall` action, it finds the corresponding function in the `uiActionFunctions` object and executes it.

### **3.1. The `functionCall` Pattern: The Key to Stability**

A critical requirement for a stable UI is that the user is never left in a "dead end" state. After a `functionCall` completes, the UI must be explicitly told what to show next. Leaving the UI flow hanging was the source of the major "not a function" crashes.

**The Correct Pattern:** Every function inside the `uiActionFunctions` object **must** conclude by calling `showPanel()`.

- **For simple actions** (e.g., `teleportTo`, `clearInventory`), the function should perform its logic and then immediately call `showPanel()` to return the user to the panel they were just on.
- **For actions that open a modal form** (e.g., `showKickForm`, `showBountyForm`), the function should handle the modal's submission or cancellation. In **all cases**, after the modal is dealt with, the function must end by calling `showPanel()` to return the user to the parent panel.

This ensures the core UI loop is never broken and provides a consistent, predictable experience for the user.

### **3.2. Opening Panels from a Command**

The user specifically requested documentation on how the `!panel` command works.

- **The Command**: The command is defined in `AddonExeBP/scripts/modules/commands/panel.js`. When a player types `!panel` (or `!ui`/`!gui`), the `execute` function is run, which simply calls `showPanel(player, 'mainPanel')`.
- **The `UserBusy` Problem**: Minecraft's API prevents a UI from being shown while the player has the chat screen open. Attempting to do so will result in a `UserBusy` error.
- **The `utils.uiWait` Solution**: The `uiManager` uses a helper function, `utils.uiWait`, to show forms. This function contains a special loop: if it detects the `UserBusy` error, it waits and retries showing the form until the player closes the chat. This provides a seamless experience, as the panel appears the moment the player exits the chat interface.
